# ok-typeless MVP Implementation Plan

**Goal:** Build a macOS menubar app where Right Cmd triggers mic recording, audio is sent to Groq Whisper for transcription (or LLM translation), and the result is pasted at the cursor via clipboard simulation.

**Architecture:** Main-heavy Electron app — all business logic in the main process, renderer is a dumb capsule overlay. State machine in main is the single source of truth; renderer receives state updates and sends audio via IPC.

**Tech Stack:** Electron, TypeScript, React, uiohook-napi, Vitest (unit tests), Playwright (integration tests), Storybook (UI fidelity)

---

## Task 1: Project Scaffold

**Deliverable:** A working `npm start` that opens an Electron window and a `npm test` that runs Vitest.

**Files:**

- Create: `package.json`, `tsconfig.json`, `electron.vite.config.ts` (or equivalent bundler config)
- Create: `src/main/main.ts` (stub)
- Create: `src/renderer/index.html`, `src/renderer/index.tsx` (stub)
- Create: `src/preload/preload.ts` (stub)

**Done when:**

- `npm start` launches Electron with a blank window
- `npm test` runs and exits cleanly (no tests yet is fine)
- TypeScript compiles with zero errors
- Project structure matches `src/main/`, `src/renderer/`, `src/shared/`, `src/preload/`

**Back pressure:** TypeScript compilation is the back pressure here. Zero `tsc` errors = scaffold is sound.

---

## Task 2: Shared Types

**Deliverable:** A single `shared/types.ts` that defines the entire state surface and IPC contract for the app.

**Files:**

- Create: `src/shared/types.ts`

**Done when:**

- `AppState` discriminated union is defined (5 states: `idle`, `connecting`, `recording`, `processing`, `error`)
- IPC channel names are exported as typed constants
- `ProviderConfig` type is defined
- File compiles with zero errors, no `any`

**Back pressure:** TypeScript — if a state is missing or a channel is mis-typed, every downstream file that imports it will fail to compile.

---

## Task 3: State Machine

**Deliverable:** A pure `stateMachine.ts` module with a `send(event)` method, plus full unit test coverage of every transition in the transition table from the tech design.

**Files:**

- Create: `src/main/state-machine.ts`
- Create: `src/main/state-machine.test.ts`

**Done when:**

- All 13 transitions from the tech design transition table are covered by tests
- All error paths reach `error` state
- All invalid transitions (e.g. hotkey during `processing`) are no-ops
- `npm test` passes

**Back pressure:** Vitest unit tests on pure functions — no mocks, no side effects. Every transition is exercised.

---

## Task 4: Hotkey Tap Detection

**Deliverable:** A pure `reduceTap(state, event) → { nextState, action }` reducer, with unit tests covering all 4 key sequences from the tech design. Plus a thin uiohook wiring layer.

**Files:**

- Create: `src/main/hotkey.ts` (pure reducer + uiohook binding)
- Create: `src/main/hotkey.test.ts`

**Done when:**

- `reduceTap` handles: tap → `transcribe`, shift-tap → `translate`, modifier-use → `null`, shift-held → `translate`
- The wiring layer calls `reduceTap` and sends result to the state machine
- `npm test` passes

**Back pressure:** Vitest unit tests on `reduceTap` in isolation — uiohook is never imported in the test file.

---

## Task 5: Preload Bridge

**Deliverable:** A `preload.ts` that exposes exactly 4 IPC methods to the renderer via `contextBridge`.

**Files:**

- Create: `src/preload/preload.ts`

**Done when:**

- `window.typeless.onStateUpdate`, `onStartRecording`, `onStopRecording`, `sendAudioData` are all exposed
- No other Electron/Node APIs are exposed
- TypeScript types match the `AppState` from `shared/types.ts`

**Back pressure:** TypeScript — the `contextBridge.exposeInMainWorld` call must satisfy the types defined in `shared/types.ts`.

---

## Task 6: API Module

**Deliverable:** A `api.ts` module with `transcribe(audio, mode)` that runs the 2-step Whisper + LLM pipeline, plus a real-API integration test using a fixture audio file.

**Files:**

- Create: `src/main/api.ts`
- Create: `src/main/api.test.ts`
- Create: `fixtures/test-audio.webm` (a short recording for testing)

**Done when:**

- `transcribe(buffer, 'transcribe')` calls Whisper then LLM cleanup, returns cleaned string
- `transcribe(buffer, 'translate')` calls Whisper then LLM translate-to-English, returns English string
- Provider selection via `TYPELESS_PROVIDER` env var works
- Missing API key at startup shows a dialog and quits
- Integration test hits real Groq API with the fixture file and asserts a non-empty result
- `npm test` passes (test skips gracefully if `GROQ_API_KEY` not set)

**Back pressure:** Real API call in integration test — validates that the actual HTTP payload, auth, and model IDs are correct.

---

## Task 7: Clipboard Output

**Deliverable:** A `clipboard-output.ts` module with `pasteText(text)` that saves clipboard, writes text, simulates Cmd+V, then restores.

**Files:**

- Create: `src/main/clipboard-output.ts`
- Create: `src/main/clipboard-output.test.ts` (Playwright)

**Done when:**

- `pasteText` uses `electron.clipboard` for read/write and `uIOhook.keyTap` for Cmd+V simulation
- Playwright test: launch a minimal Electron window with a focused text input, call `pasteText("hello")`, assert field value is `"hello"` and original clipboard is restored
- `npm test` passes

**Back pressure:** Playwright drives a real Electron window — the paste must actually land in the text field, not just simulate it in memory.

---

## Task 8: IPC Handlers

**Deliverable:** `ipc-handlers.ts` wires the state machine, API module, and clipboard module together. When state machine reaches `processing`, it calls `api.transcribe`, then `pasteText` or transitions to `error`.

**Files:**

- Create: `src/main/ipc-handlers.ts`

**Done when:**

- `audio-data` IPC message from renderer triggers `api.transcribe`
- On success with non-empty result: calls `pasteText`, transitions state machine to `idle`
- On success with empty result: transitions to `error("Nothing heard")`
- On failure: transitions to `error(message)`
- State updates are broadcast to renderer on every transition
- `start-recording` and `stop-recording` IPC commands are sent at the right transitions

**Back pressure:** State machine unit tests validate the logic; real audio pipeline (Task 6) validates the integration.

---

## Task 9: App Entry

**Deliverable:** `main.ts` implements the full startup sequence: accessibility check, API key check, tray icon, capsule window creation, uiohook start.

**Files:**

- Modify: `src/main/main.ts`
- Create: `assets/tray-icon.png` (16x16 or 22x22 menubar icon)

**Done when:**

- `npm start` shows a tray icon (no Dock icon)
- Tray menu has "About ok-typeless" and "Quit"
- Missing accessibility permission shows dialog and quits
- Missing API key shows dialog and quits
- Capsule window is created with the correct `BrowserWindow` config from the tech design (transparent, no frame, always-on-top, no focus)
- Capsule window is hidden at startup (shows only when state changes away from `idle`)

**Back pressure:** Manual smoke test + Playwright startup test asserting no crash and tray presence.

---

## Task 10: Renderer — Audio Recorder Hook

**Deliverable:** `useAudioRecorder` hook with dual-path recording (MediaRecorder + AudioContext/VAD) and a live `vu` level for the waveform.

**Files:**

- Create: `src/renderer/lib/vad.ts` (VadLite — ported from scribe)
- Create: `src/renderer/hooks/useAudioRecorder.ts`

**Also update (retroactive fixes for Tasks 2, 5, 8):**
- `src/shared/types.ts`: add `MIC_READY`, `MIC_ERROR` to `IPC_CHANNELS`; add `sendMicReady`, `sendMicError` to `TypelessApi`
- `src/preload/preload.ts`: expose `sendMicReady`, `sendMicError`
- `src/main/ipc-handlers.ts`: handle `mic-ready` → `MIC_READY`; `mic-error` → `MIC_FAILED`; `audio-data` from `recording` state (VAD auto-stop path)

**Done when:**

- `onStartRecording` IPC → `getUserMedia` with 5s timeout; on success starts both MediaRecorder and ScriptProcessorNode + VadLite, calls `sendMicReady`; on failure calls `sendMicError(message)`
- `onStopRecording` IPC → stops MediaRecorder, assembles chunks, calls `sendAudioData`
- VAD auto-stop → 1.5 s silence after voice activity triggers same stop + send sequence
- `vu` (0–1) returned from hook, updates every ~16 ms PCM frame
- `npm test` passes (VadLite unit tests)

**Back pressure:** VadLite unit tests; TypeScript IPC contract enforcement.

---

## Task 11: Renderer — UI Components

**Deliverable:** `Capsule.tsx`, `Waveform.tsx`, `TipBubble.tsx` components, each with a Storybook story for every relevant `AppState`.

**Files:**

- Create: `src/renderer/components/Capsule.tsx`
- Create: `src/renderer/components/Waveform.tsx`
- Create: `src/renderer/components/TipBubble.tsx`
- Create: `src/renderer/styles/capsule.css`
- Create: `src/renderer/components/*.stories.tsx` (Storybook stories)

**Done when:**

- `Capsule` renders black rounded container, fade in/out, correct dimensions (200×44px)
- `Waveform` renders animated white bars during `recording` state
- `TipBubble` renders black bubble above capsule, auto-dismisses after 2s
- Storybook stories cover: connecting/transcribe, connecting/translate, recording/transcribe, recording/translate, processing/transcribe, processing/translate, error states
- Visual distinction between "Connecting" (pulsing dot) and "Recording" (waveform) is immediately obvious

**Back pressure:** Storybook visual review for each state. Playwright screenshot tests per state transition are added in Task 13.

---

## Task 12: Renderer — App Root

**Deliverable:** `App.tsx` listens to `state-update` IPC, renders the correct component tree based on `AppState`.

**Files:**

- Create: `src/renderer/App.tsx`
- Modify: `src/renderer/index.tsx` (mount App)

**Done when:**

- `App` subscribes to `window.typeless.onStateUpdate` on mount
- Renders `null` (hidden capsule) when `status === 'idle'`
- Renders `Capsule` with correct contents for each non-idle state
- Renders `TipBubble` when `status === 'error'`

**Back pressure:** TypeScript exhaustive switch on `AppState.status` — the compiler will catch any unhandled state.

---

## Task 13: End-to-End Integration

**Deliverable:** Playwright tests that drive the full running app through the happy path and all error paths.

**Files:**

- Create: `e2e/full-flow.test.ts`

**Done when:**

- Happy path test: launch app → simulate Right Cmd tap → app enters `connecting` → mic ready → `recording` → second Right Cmd tap → `processing` → text pasted into a test window → `idle`
- Error paths tested: mic denied, network error (mock API endpoint), empty transcription
- All 5 error scenarios from the tech design runtime error table produce a tip bubble and return to `idle`
- Clipboard is restored after paste

**Back pressure:** Playwright against the live running app — these tests catch wiring bugs that unit tests cannot.

---

## Milestone Summary

| #   | Task             | Key Deliverable                 | Back Pressure             |
| --- | ---------------- | ------------------------------- | ------------------------- |
| 1   | Project Scaffold | `npm start` + `npm test` green  | `tsc`                     |
| 2   | Shared Types     | `AppState` + IPC contract       | `tsc`                     |
| 3   | State Machine    | All 13 transitions              | Vitest unit               |
| 4   | Hotkey Detection | `reduceTap` reducer             | Vitest unit               |
| 5   | Preload Bridge   | `contextBridge` surface         | `tsc`                     |
| 6   | API Module       | Whisper + LLM pipeline          | Real API integration test |
| 7   | Clipboard Output | Paste + restore                 | Playwright                |
| 8   | IPC Handlers     | State ↔ API ↔ clipboard wired | Covered by 3 + 6          |
| 9   | App Entry        | Tray + window + startup checks  | Smoke test                |
| 10  | Audio Recorder   | `useAudioRecorder` hook         | `tsc` + manual            |
| 11  | UI Components    | Capsule + Waveform + TipBubble  | Storybook                 |
| 12  | App Root         | `App.tsx` state-driven render   | `tsc` exhaustive switch   |
| 13  | E2E Integration  | Full flow + all error paths     | Playwright                |
