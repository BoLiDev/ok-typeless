# E2E AI Test Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** A `npm run test:ai` script that runs pre-recorded audio fixtures through the full STT + LLM pipeline and prints results to the terminal for manual quality review.

**Architecture:** A standalone TypeScript script (`scripts/e2e-ai.ts`) run via `tsx`. It reads a shared config from `test/e2e-ai/config.json`, scans `test/e2e-ai/fixtures/` for `.wav`/`.webm` files, calls `transcribe()` from `src/main/llm/api.ts` for each, and prints a formatted terminal table. Always exits 0 unless an API error occurs.

**Tech Stack:** tsx (TypeScript runner), dotenv, Node.js `fs` module, existing `transcribe()` function from `src/main/llm/api.ts`.

---

### Task 1: Install tsx

**Files:**
- Modify: `package.json`

**Step 1: Install tsx as a dev dependency**

```bash
npm install --save-dev tsx
```

Expected: `tsx` appears in `devDependencies` in `package.json`.

**Step 2: Verify tsx runs**

```bash
npx tsx --version
```

Expected: prints a version string like `4.x.x`.

**Step 3: Commit**

```bash
git add package.json package-lock.json
git commit -m "chore: add tsx for e2e-ai script runner"
```

---

### Task 2: Set up test/e2e-ai directory

**Files:**
- Create: `test/e2e-ai/config.json`
- Create: `test/e2e-ai/fixtures/.gitkeep`
- Modify: `.gitignore`

**Step 1: Create config.json**

```bash
mkdir -p test/e2e-ai/fixtures
```

Create `test/e2e-ai/config.json`:

```json
{
  "mode": "transcribe",
  "skipPostProcessing": false
}
```

`mode` can be `"transcribe"` or `"translate"`. Change this to switch what all fixtures are tested against.

**Step 2: Create fixtures placeholder**

```bash
touch test/e2e-ai/fixtures/.gitkeep
```

This tracks the directory in git without committing audio files.

**Step 3: Gitignore audio files in fixtures**

Add to `.gitignore`:

```
test/e2e-ai/fixtures/*.wav
test/e2e-ai/fixtures/*.webm
```

**Step 4: Commit**

```bash
git add test/e2e-ai/config.json test/e2e-ai/fixtures/.gitkeep .gitignore
git commit -m "chore: add e2e-ai test directory and config"
```

---

### Task 3: Write the runner script

**Files:**
- Create: `scripts/e2e-ai.ts`
- Modify: `tsconfig.json` (add scripts to include)

**Step 1: Add scripts/ to tsconfig include**

Open `tsconfig.json`. The `include` array currently has `"src/**/*"` and others. Add `"scripts/**/*"` so typecheck covers the new script:

```json
"include": [
  "src/**/*",
  "scripts/**/*",
  "e2e/**/*",
  "electron.vite.config.ts",
  "vitest.config.ts",
  "playwright.config.ts"
]
```

**Step 2: Create scripts/e2e-ai.ts**

```typescript
import "dotenv/config";
import { readFileSync, readdirSync, existsSync } from "node:fs";
import { resolve, extname } from "node:path";
import { transcribe } from "../src/main/llm/api";
import type { RecordingMode } from "@shared/types";

interface E2eAiConfig {
  mode: RecordingMode;
  skipPostProcessing: boolean;
}

const ROOT = resolve(__dirname, "..");
const FIXTURES_DIR = resolve(ROOT, "test/e2e-ai/fixtures");
const CONFIG_PATH = resolve(ROOT, "test/e2e-ai/config.json");
const DIVIDER = "─".repeat(70);

function loadConfig(): E2eAiConfig {
  const raw = readFileSync(CONFIG_PATH, "utf-8");
  return JSON.parse(raw) as E2eAiConfig;
}

function loadFixtures(): string[] {
  if (!existsSync(FIXTURES_DIR)) return [];
  return readdirSync(FIXTURES_DIR)
    .filter((f) => [".wav", ".webm"].includes(extname(f)))
    .sort();
}

async function main(): Promise<void> {
  const config = loadConfig();
  const fixtures = loadFixtures();

  if (fixtures.length === 0) {
    console.log("No fixtures found in test/e2e-ai/fixtures/");
    return;
  }

  console.log(
    `\nE2E AI Test  (mode: ${config.mode} | skipPostProcessing: ${config.skipPostProcessing})`,
  );
  console.log(DIVIDER);

  let failed = 0;

  for (let i = 0; i < fixtures.length; i++) {
    const fileName = fixtures[i];
    const filePath = resolve(FIXTURES_DIR, fileName);

    console.log(`\n[${i + 1}/${fixtures.length}] ${fileName}`);

    try {
      const buffer = readFileSync(filePath).buffer as ArrayBuffer;
      const result = await transcribe(
        buffer,
        config.mode,
        fileName,
        config.skipPostProcessing,
      );
      console.log(`  STT (${result.sttMs}ms):  ${result.sttRaw}`);
      console.log(`  LLM (${result.llmMs}ms): ${result.llmOut}`);
    } catch (err) {
      const message = err instanceof Error ? err.message : String(err);
      console.error(`  ERROR: ${message}`);
      failed++;
    }
  }

  console.log(`\n${DIVIDER}`);
  if (failed > 0) {
    console.log(`✗  ${failed} failed, ${fixtures.length - failed} passed`);
    process.exit(1);
  } else {
    console.log(`✓  ${fixtures.length} fixtures completed`);
  }
}

main();
```

**Step 3: Add npm script to package.json**

In the `"scripts"` section of `package.json`, add:

```json
"test:ai": "tsx scripts/e2e-ai.ts"
```

**Step 4: Typecheck**

```bash
npm run typecheck
```

Expected: no errors.

**Step 5: Commit**

```bash
git add scripts/e2e-ai.ts package.json tsconfig.json
git commit -m "feat: add test:ai e2e script for manual AI quality review"
```

---

### Task 4: Smoke test

**Files:** none (just verification)

**Step 1: Drop a real .wav file into fixtures**

Copy any audio file to `test/e2e-ai/fixtures/sample.wav`. Must be a valid WAV file with speech.

**Step 2: Run the script**

```bash
npm run test:ai
```

Expected output:

```
E2E AI Test  (mode: transcribe | skipPostProcessing: false)
──────────────────────────────────────────────────────────────────────────

[1/1] sample.wav
  STT (XXms):  <raw transcription>
  LLM (XXms):  <cleaned text>

──────────────────────────────────────────────────────────────────────────
✓  1 fixtures completed
```

Expected exit code: 0.

**Step 3: Verify error path works**

Temporarily set a wrong API key in `.env`, then run again.

Expected: `ERROR: Whisper API error 401: ...` is printed, exit code 1.

Restore the correct key afterwards.
